name: WeRead to Flomo Sync

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤© UTC 00:00ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰è¿è¡Œ
  schedule:
    - cron: '10 12 * * *'
    
  # æ›´å¤šæ—¶é—´é€‰é¡¹ï¼ˆå–æ¶ˆæ³¨é‡Šå³å¯ä½¿ç”¨ï¼‰ï¼š
  # - cron: '0 0,12 * * *'     # æ¯å¤© 2 æ¬¡ï¼ˆæ—© 8:00 å’Œæ™š 8:00 åŒ—äº¬æ—¶é—´ï¼‰
  # - cron: '0 */6 * * *'      # æ¯ 6 å°æ—¶ä¸€æ¬¡
  # - cron: '0 22 * * *'       # æ¯å¤©æ—©ä¸Š 6:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  # - cron: '0 0 * * 1'        # æ¯å‘¨ä¸€æ—©ä¸Š 8:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      days_limit:
        description: 'åªåŒæ­¥æœ€è¿‘å‡ å¤©çš„åˆ’çº¿ï¼ˆç•™ç©ºä½¿ç”¨é…ç½®æ–‡ä»¶é»˜è®¤å€¼ï¼‰'
        required: false
        default: ''
      max_highlights:
        description: 'æœ€å¤šåŒæ­¥å‡ æ¡åˆ’çº¿ï¼ˆç•™ç©ºä½¿ç”¨é…ç½®æ–‡ä»¶é»˜è®¤å€¼ï¼‰'
        required: false
        default: ''

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: é…ç½®ç¯å¢ƒå˜é‡
      run: |
        # åˆ›å»º .env æ–‡ä»¶ï¼ˆåªå†™å…¥éç©ºçš„é…ç½®é¡¹ï¼‰
        touch .env
        
        # Cookie Cloud é…ç½®ï¼ˆæ¨èï¼‰
        if [ -n "${{ secrets.CC_URL }}" ]; then
          echo 'CC_URL="${{ secrets.CC_URL }}"' >> .env
        fi
        if [ -n "${{ secrets.CC_ID }}" ]; then
          echo 'CC_ID="${{ secrets.CC_ID }}"' >> .env
        fi
        if [ -n "${{ secrets.CC_PASSWORD }}" ]; then
          echo 'CC_PASSWORD="${{ secrets.CC_PASSWORD }}"' >> .env
        fi
        
        # å¤‡ç”¨ Cookieï¼ˆå¦‚æœ Cookie Cloud å¤±è´¥ï¼‰
        if [ -n "${{ secrets.WEREAD_COOKIE }}" ]; then
          echo 'WEREAD_COOKIE="${{ secrets.WEREAD_COOKIE }}"' >> .env
        fi
        
        # Flomo APIï¼ˆå¿…éœ€ï¼‰
        if [ -n "${{ secrets.FLOMO_API }}" ]; then
          echo 'FLOMO_API="${{ secrets.FLOMO_API }}"' >> .env
        fi
        
        # AI é…ç½®ï¼ˆå¯é€‰ï¼‰
        if [ -n "${{ secrets.AI_API_KEY }}" ]; then
          echo 'AI_API_KEY="${{ secrets.AI_API_KEY }}"' >> .env
        fi
        if [ -n "${{ secrets.AI_API_BASE }}" ]; then
          echo 'AI_API_BASE="${{ secrets.AI_API_BASE }}"' >> .env
        fi
        if [ -n "${{ secrets.AI_MODEL }}" ]; then
          echo 'AI_MODEL="${{ secrets.AI_MODEL }}"' >> .env
        fi
        
        # åŒæ­¥é…ç½®ï¼ˆä½¿ç”¨è¾“å…¥å‚æ•°æˆ– secretsï¼Œä¼˜å…ˆä½¿ç”¨è¾“å…¥å‚æ•°ï¼‰
        DAYS_LIMIT="${{ github.event.inputs.days_limit }}"
        if [ -z "$DAYS_LIMIT" ] && [ -n "${{ secrets.SYNC_DAYS_LIMIT }}" ]; then
          DAYS_LIMIT="${{ secrets.SYNC_DAYS_LIMIT }}"
        fi
        if [ -n "$DAYS_LIMIT" ]; then
          echo "SYNC_DAYS_LIMIT=$DAYS_LIMIT" >> .env
        fi
        
        MAX_HIGHLIGHTS="${{ github.event.inputs.max_highlights }}"
        if [ -z "$MAX_HIGHLIGHTS" ] && [ -n "${{ secrets.SYNC_MAX_HIGHLIGHTS }}" ]; then
          MAX_HIGHLIGHTS="${{ secrets.SYNC_MAX_HIGHLIGHTS }}"
        fi
        if [ -n "$MAX_HIGHLIGHTS" ]; then
          echo "SYNC_MAX_HIGHLIGHTS=$MAX_HIGHLIGHTS" >> .env
        fi
        
        echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"
        
    - name: è¿è¡ŒåŒæ­¥
      run: |
        echo "ğŸš€ å¼€å§‹åŒæ­¥..."
        echo "â° è¿è¡Œæ—¶é—´: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        # è¿è¡ŒåŒæ­¥å¹¶æ•è·è¾“å‡º
        python sync.py 2>&1 | tee sync.log
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo ""
          echo "âœ… åŒæ­¥æˆåŠŸå®Œæˆï¼"
        else
          echo ""
          echo "âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
          exit 1
        fi
        
    - name: ä¸Šä¼ åŒæ­¥è®°å½•å’Œæ—¥å¿—
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sync-records-${{ github.run_number }}
        path: |
          synced_bookmarks.json
          sync.log
        retention-days: 30
        
    - name: æäº¤åŒæ­¥è®°å½•
      if: success()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add synced_bookmarks.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update sync records [skip ci]" && git push)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ç”ŸæˆåŒæ­¥æ‘˜è¦
      if: always()
      run: |
        echo "## ğŸ“Š åŒæ­¥ä»»åŠ¡æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡Œæ—¶é—´**: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -f sync.log ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ æ—¥å¿—æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 sync.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: åˆ›å»ºå¤±è´¥é€šçŸ¥ Issue
      if: failure() && github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let logContent = 'æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨';
          
          if (fs.existsSync('sync.log')) {
            logContent = fs.readFileSync('sync.log', 'utf8');
            // é™åˆ¶æ—¥å¿—é•¿åº¦ï¼Œé¿å… Issue è¿‡å¤§
            if (logContent.length > 10000) {
              logContent = logContent.substring(logContent.length - 10000);
              logContent = '...(æ—¥å¿—å·²æˆªæ–­)\n\n' + logContent;
            }
          }
          
          const title = `ğŸš¨ å®šæ—¶åŒæ­¥å¤±è´¥ - ${new Date().toISOString().split('T')[0]}`;
          const body = `## åŒæ­¥ä»»åŠ¡å¤±è´¥
          
          **æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
          **Workflow Run**: [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
          
          ### é”™è¯¯æ—¥å¿—
          
          \`\`\`
          ${logContent}
          \`\`\`
          
          ### å¯èƒ½çš„åŸå› 
          
          1. Cookie å·²è¿‡æœŸï¼Œéœ€è¦æ›´æ–°
          2. Flomo API è¾¾åˆ°é™åˆ¶
          3. ç½‘ç»œè¿æ¥é—®é¢˜
          4. é…ç½®é”™è¯¯
          
          ### è§£å†³æ–¹æ¡ˆ
          
          1. æ£€æŸ¥ GitHub Secrets é…ç½®
          2. æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡æµ‹è¯•ï¼šActions â†’ WeRead to Flomo Sync â†’ Run workflow
          3. æŸ¥çœ‹å®Œæ•´æ—¥å¿—ï¼š[ç‚¹å‡»è¿™é‡Œ](${context.payload.repository.html_url}/actions/runs/${context.runId})
          
          ---
          *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`;
          
          // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä»Šå¤©çš„å¤±è´¥ Issue
          const today = new Date().toISOString().split('T')[0];
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'auto-sync-failure',
            per_page: 5
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes(today)
          );
          
          if (existingIssue) {
            // æ›´æ–°ç°æœ‰ Issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `å†æ¬¡å¤±è´¥äº ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n\n${body}`
            });
          } else {
            // åˆ›å»ºæ–° Issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['auto-sync-failure', 'bug']
            });
          }
