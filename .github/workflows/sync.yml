name: WeRead to Flomo Sync

on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ 20:30 è¿è¡Œ
  schedule:
    - cron: '30 12 * * *'  # UTC 12:30 = åŒ—äº¬æ—¶é—´ 20:30
    
  # æ›´å¤šæ—¶é—´é€‰é¡¹ï¼ˆå–æ¶ˆæ³¨é‡Šå³å¯ä½¿ç”¨ï¼‰ï¼š
  # - cron: '0 0,12 * * *'     # æ¯å¤© 2 æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ 08:00 å’Œ 20:00ï¼‰
  # - cron: '0 */6 * * *'      # æ¯ 6 å°æ—¶ä¸€æ¬¡
  # - cron: '0 22 * * *'       # æ¯å¤©æ—©ä¸Š 6:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  # - cron: '0 0 * * 1'        # æ¯å‘¨ä¸€æ—©ä¸Š 8:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      days_limit:
        description: 'åªåŒæ­¥æœ€è¿‘å‡ å¤©çš„åˆ’çº¿ï¼ˆç•™ç©ºä½¿ç”¨é…ç½®æ–‡ä»¶é»˜è®¤å€¼ï¼‰'
        required: false
        default: ''
      max_highlights:
        description: 'æœ€å¤šåŒæ­¥å‡ æ¡åˆ’çº¿ï¼ˆç•™ç©ºä½¿ç”¨é…ç½®æ–‡ä»¶é»˜è®¤å€¼ï¼‰'
        required: false
        default: ''

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: é…ç½®ç¯å¢ƒå˜é‡
      run: |
        # åˆ›å»º .env æ–‡ä»¶ï¼ˆåªå†™å…¥éç©ºçš„é…ç½®é¡¹ï¼‰
        touch .env
        
        # Cookie Cloud é…ç½®ï¼ˆæ¨èï¼‰
        if [ -n "${{ secrets.CC_URL }}" ]; then
          echo 'CC_URL="${{ secrets.CC_URL }}"' >> .env
        fi
        if [ -n "${{ secrets.CC_ID }}" ]; then
          echo 'CC_ID="${{ secrets.CC_ID }}"' >> .env
        fi
        if [ -n "${{ secrets.CC_PASSWORD }}" ]; then
          echo 'CC_PASSWORD="${{ secrets.CC_PASSWORD }}"' >> .env
        fi
        
        # å¤‡ç”¨ Cookieï¼ˆå¦‚æœ Cookie Cloud å¤±è´¥ï¼‰
        if [ -n "${{ secrets.WEREAD_COOKIE }}" ]; then
          echo 'WEREAD_COOKIE="${{ secrets.WEREAD_COOKIE }}"' >> .env
        fi
        
        # Flomo APIï¼ˆå¿…éœ€ï¼‰
        if [ -n "${{ secrets.FLOMO_API }}" ]; then
          echo 'FLOMO_API="${{ secrets.FLOMO_API }}"' >> .env
        fi
        
        # AI é…ç½®ï¼ˆå¯é€‰ï¼‰
        if [ -n "${{ secrets.AI_API_KEY }}" ]; then
          echo 'AI_API_KEY="${{ secrets.AI_API_KEY }}"' >> .env
        fi
        if [ -n "${{ secrets.AI_API_BASE }}" ]; then
          echo 'AI_API_BASE="${{ secrets.AI_API_BASE }}"' >> .env
        fi
        if [ -n "${{ secrets.AI_MODEL }}" ]; then
          echo 'AI_MODEL="${{ secrets.AI_MODEL }}"' >> .env
        fi
        
        # åŒæ­¥é…ç½®ï¼ˆä½¿ç”¨è¾“å…¥å‚æ•°æˆ– secretsï¼Œä¼˜å…ˆä½¿ç”¨è¾“å…¥å‚æ•°ï¼‰
        DAYS_LIMIT="${{ github.event.inputs.days_limit }}"
        if [ -z "$DAYS_LIMIT" ] && [ -n "${{ secrets.SYNC_DAYS_LIMIT }}" ]; then
          DAYS_LIMIT="${{ secrets.SYNC_DAYS_LIMIT }}"
        fi
        if [ -n "$DAYS_LIMIT" ]; then
          echo "SYNC_DAYS_LIMIT=$DAYS_LIMIT" >> .env
        fi
        
        MAX_HIGHLIGHTS="${{ github.event.inputs.max_highlights }}"
        if [ -z "$MAX_HIGHLIGHTS" ] && [ -n "${{ secrets.SYNC_MAX_HIGHLIGHTS }}" ]; then
          MAX_HIGHLIGHTS="${{ secrets.SYNC_MAX_HIGHLIGHTS }}"
        fi
        if [ -n "$MAX_HIGHLIGHTS" ]; then
          echo "SYNC_MAX_HIGHLIGHTS=$MAX_HIGHLIGHTS" >> .env
        fi
        
        echo "âœ… ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ"
        
    - name: è¿è¡ŒåŒæ­¥
      run: |
        echo "ğŸš€ å¼€å§‹åŒæ­¥..."
        echo "â° è¿è¡Œæ—¶é—´: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        # è¿è¡ŒåŒæ­¥å¹¶æ•è·è¾“å‡º
        python sync.py 2>&1 | tee sync.log
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo ""
          echo "âœ… åŒæ­¥æˆåŠŸå®Œæˆï¼"
        else
          echo ""
          echo "âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
          exit 1
        fi
        
    - name: ä¸Šä¼ åŒæ­¥è®°å½•å’Œæ—¥å¿—
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: sync-records-${{ github.run_number }}
        path: |
          synced_bookmarks.json
          sync.log
        retention-days: 30
        
    - name: æäº¤åŒæ­¥è®°å½•
      if: success()
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add synced_bookmarks.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update sync records [skip ci]" && git push)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ç”ŸæˆåŒæ­¥æ‘˜è¦
      if: always()
      run: |
        echo "# ğŸ“Š WeRead2Flomo åŒæ­¥ä»»åŠ¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # åŸºæœ¬ä¿¡æ¯
        echo "## ğŸ“… åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
        echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
        echo "| è¿è¡Œæ—¶é—´ | $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S') |" >> $GITHUB_STEP_SUMMARY
        echo "| è§¦å‘æ–¹å¼ | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Workflow Run | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æå–é…ç½®ä¿¡æ¯
        if [ -f sync.log ]; then
          echo "## âš™ï¸ é…ç½®è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æå–é…ç½®ä¿¡æ¯éƒ¨åˆ†
          if grep -q "âš™ï¸  é…ç½®ä¿¡æ¯" sync.log; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            sed -n '/âš™ï¸  é…ç½®ä¿¡æ¯/,/å¼€å§‹åŒæ­¥å¾®ä¿¡è¯»ä¹¦åˆ’çº¿åˆ° flomo/p' sync.log | head -n -2 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # æå–åŒæ­¥ç»“æœç»Ÿè®¡
          echo "## ğŸ“ˆ åŒæ­¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if grep -q "âœ… åŒæ­¥å®Œæˆ!" sync.log; then
            # åŸºæœ¬ç»Ÿè®¡
            echo "### ğŸ“Š åŸºæœ¬ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
            
            PROCESSED_BOOKS=$(grep -A 1 "ğŸ“Š åŸºæœ¬ç»Ÿè®¡:" sync.log | grep "å¤„ç†ä¹¦ç±:" | sed -E 's/.*å¤„ç†ä¹¦ç±: ([0-9]+)\/([0-9]+).*/\1/')
            TOTAL_BOOKS=$(grep -A 1 "ğŸ“Š åŸºæœ¬ç»Ÿè®¡:" sync.log | grep "å¤„ç†ä¹¦ç±:" | sed -E 's/.*å¤„ç†ä¹¦ç±: ([0-9]+)\/([0-9]+).*/\2/')
            NEW_SYNCED=$(grep "æœ¬æ¬¡æ–°åŒæ­¥:" sync.log | tail -1 | sed -E 's/.*æœ¬æ¬¡æ–°åŒæ­¥: ([0-9]+).*/\1/')
            TOTAL_SYNCED=$(grep "ç´¯è®¡å·²åŒæ­¥:" sync.log | tail -1 | sed -E 's/.*ç´¯è®¡å·²åŒæ­¥: ([0-9]+).*/\1/')
            FAILED=$(grep "å¤±è´¥æ•°é‡:" sync.log | tail -1 | sed -E 's/.*å¤±è´¥æ•°é‡: ([0-9]+).*/\1/')
            
            echo "| ğŸ“š å¤„ç†ä¹¦ç± | ${PROCESSED_BOOKS:-0}/${TOTAL_BOOKS:-0} | æœ¬æ¬¡å¤„ç†çš„ä¹¦ç±æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
            echo "| âœ¨ æ–°å¢åˆ’çº¿ | ${NEW_SYNCED:-0} æ¡ | æœ¬æ¬¡æ–°åŒæ­¥çš„åˆ’çº¿ |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ“Š ç´¯è®¡åˆ’çº¿ | ${TOTAL_SYNCED:-0} æ¡ | å†å²ç´¯è®¡åŒæ­¥æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
            if [ "${FAILED:-0}" -gt 0 ]; then
              echo "| âŒ å¤±è´¥æ•°é‡ | ${FAILED:-0} æ¡ | å‘é€å¤±è´¥çš„åˆ’çº¿ |" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # æ€§èƒ½æŒ‡æ ‡
            if grep -q "â±ï¸  æ€§èƒ½æŒ‡æ ‡:" sync.log; then
              echo "### â±ï¸  æ€§èƒ½æŒ‡æ ‡" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| æŒ‡æ ‡ | æ•°å€¼ |" >> $GITHUB_STEP_SUMMARY
              echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
              
              DURATION=$(grep "åŒæ­¥è€—æ—¶:" sync.log | tail -1 | sed -E 's/.*åŒæ­¥è€—æ—¶: ([0-9.]+) ç§’.*/\1/')
              SPEED=$(grep "å¹³å‡é€Ÿåº¦:" sync.log | tail -1 | sed -E 's/.*å¹³å‡é€Ÿåº¦: ([0-9.]+) æ¡.*/\1/')
              AVG_TIME=$(grep "å¹³å‡è€—æ—¶:" sync.log | tail -1 | sed -E 's/.*å¹³å‡è€—æ—¶: ([0-9.]+) ç§’.*/\1/')
              
              if [ -n "$DURATION" ]; then
                DURATION_MIN=$(awk "BEGIN {printf \"%.1f\", $DURATION/60}")
                echo "| â° åŒæ­¥è€—æ—¶ | ${DURATION}ç§’ (${DURATION_MIN}åˆ†é’Ÿ) |" >> $GITHUB_STEP_SUMMARY
              fi
              if [ -n "$SPEED" ]; then
                echo "| ğŸš€ å¹³å‡é€Ÿåº¦ | ${SPEED} æ¡/åˆ†é’Ÿ |" >> $GITHUB_STEP_SUMMARY
              fi
              if [ -n "$AVG_TIME" ]; then
                echo "| â³ å¹³å‡è€—æ—¶ | ${AVG_TIME} ç§’/æ¡ |" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Flomo API ä½¿ç”¨æƒ…å†µ
            echo "### ğŸ“¤ Flomo API ä½¿ç”¨æƒ…å†µ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| æŒ‡æ ‡ | æ•°å€¼ |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
            
            API_CALLS=$(grep "API è°ƒç”¨:" sync.log | tail -1 | sed -E 's/.*API è°ƒç”¨: ([0-9]+)\/([0-9]+).*/\1/')
            API_LIMIT=$(grep "API è°ƒç”¨:" sync.log | tail -1 | sed -E 's/.*API è°ƒç”¨: ([0-9]+)\/([0-9]+).*/\2/')
            API_USAGE=$(grep "ä½¿ç”¨ç‡:" sync.log | tail -1 | sed -E 's/.*ä½¿ç”¨ç‡: ([0-9.]+)%.*/\1/')
            API_REMAINING=$(grep "å‰©ä½™é…é¢:" sync.log | tail -1 | sed -E 's/.*å‰©ä½™é…é¢: ([0-9]+).*/\1/')
            
            echo "| ğŸ”— API è°ƒç”¨ | ${API_CALLS:-0}/${API_LIMIT:-100} æ¬¡ |" >> $GITHUB_STEP_SUMMARY
            if [ -n "$API_USAGE" ]; then
              echo "| ğŸ“ˆ ä½¿ç”¨ç‡ | ${API_USAGE}% |" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$API_REMAINING" ]; then
              echo "| ğŸ’° å‰©ä½™é…é¢ | ${API_REMAINING} æ¬¡ |" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # AI åŠŸèƒ½ç»Ÿè®¡
            if grep -q "ğŸ¤– AI åŠŸèƒ½ç»Ÿè®¡:" sync.log; then
              echo "### ğŸ¤– AI åŠŸèƒ½ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if grep -q "AI æ‘˜è¦:" sync.log; then
                SUMMARY_ATTEMPTED=$(grep -A 3 "AI æ‘˜è¦:" sync.log | grep "å°è¯•:" | sed -E 's/.*å°è¯•: ([0-9]+).*/\1/')
                SUMMARY_SUCCESS=$(grep -A 3 "AI æ‘˜è¦:" sync.log | grep "æˆåŠŸ:" | sed -E 's/.*æˆåŠŸ: ([0-9]+).*/\1/')
                SUMMARY_RATE=$(grep -A 3 "AI æ‘˜è¦:" sync.log | grep "æˆåŠŸç‡:" | sed -E 's/.*æˆåŠŸç‡: ([0-9.]+)%.*/\1/')
                
                echo "**AI æ‘˜è¦:**" >> $GITHUB_STEP_SUMMARY
                echo "- å°è¯•: ${SUMMARY_ATTEMPTED:-0} æ¬¡" >> $GITHUB_STEP_SUMMARY
                echo "- æˆåŠŸ: ${SUMMARY_SUCCESS:-0} æ¬¡" >> $GITHUB_STEP_SUMMARY
                echo "- æˆåŠŸç‡: ${SUMMARY_RATE:-0}%" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              if grep -q "AI æ ‡ç­¾:" sync.log; then
                TAGS_ATTEMPTED=$(grep -A 3 "AI æ ‡ç­¾:" sync.log | grep "å°è¯•:" | sed -E 's/.*å°è¯•: ([0-9]+).*/\1/')
                TAGS_SUCCESS=$(grep -A 3 "AI æ ‡ç­¾:" sync.log | grep "æˆåŠŸ:" | sed -E 's/.*æˆåŠŸ: ([0-9]+).*/\1/')
                TAGS_RATE=$(grep -A 3 "AI æ ‡ç­¾:" sync.log | grep "æˆåŠŸç‡:" | sed -E 's/.*æˆåŠŸç‡: ([0-9.]+)%.*/\1/')
                
                echo "**AI æ ‡ç­¾:**" >> $GITHUB_STEP_SUMMARY
                echo "- å°è¯•: ${TAGS_ATTEMPTED:-0} æ¬¡" >> $GITHUB_STEP_SUMMARY
                echo "- æˆåŠŸ: ${TAGS_SUCCESS:-0} æ¬¡" >> $GITHUB_STEP_SUMMARY
                echo "- æˆåŠŸç‡: ${TAGS_RATE:-0}%" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            # ä¹¦ç±å¤„ç†è¯¦æƒ…
            if grep -q "ğŸ“š ä¹¦ç±å¤„ç†è¯¦æƒ…:" sync.log; then
              echo "### ğŸ“š ä¹¦ç±å¤„ç†è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              sed -n '/ğŸ“š ä¹¦ç±å¤„ç†è¯¦æƒ…:/,/^$/p' sync.log | grep "ã€Š" | head -10 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            # é”™è¯¯å’Œè­¦å‘Š
            if grep -q "âŒ é”™è¯¯" sync.log || grep -q "âš ï¸  è­¦å‘Š" sync.log; then
              echo "### âš ï¸  é”™è¯¯å’Œè­¦å‘Š" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              if grep -q "âŒ é”™è¯¯" sync.log; then
                ERROR_COUNT=$(grep "âŒ é”™è¯¯" sync.log | sed -E 's/.*âŒ é”™è¯¯ \(([0-9]+)\).*/\1/')
                echo "**é”™è¯¯ (${ERROR_COUNT:-0}):**" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                sed -n '/âŒ é”™è¯¯/,/^$/p' sync.log | grep "   -" | head -5 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
              
              if grep -q "âš ï¸  è­¦å‘Š" sync.log; then
                WARNING_COUNT=$(grep "âš ï¸  è­¦å‘Š" sync.log | sed -E 's/.*âš ï¸  è­¦å‘Š \(([0-9]+)\).*/\1/')
                echo "**è­¦å‘Š (${WARNING_COUNT:-0}):**" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                sed -n '/âš ï¸  è­¦å‘Š/,/^$/p' sync.log | grep "   -" | head -5 >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            # å»ºè®®
            if grep -q "ğŸ’¡ å»ºè®®:" sync.log; then
              echo "### ğŸ’¡ å»ºè®®" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              sed -n '/ğŸ’¡ å»ºè®®:/,/^==/p' sync.log | grep "   -" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
          else
            echo "âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # è¯¦ç»†æ—¥å¿—ï¼ˆæœ€å30è¡Œï¼‰
          echo "## ğŸ“ è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>ç‚¹å‡»å±•å¼€æŸ¥çœ‹å®Œæ•´æ—¥å¿—ï¼ˆæœ€å30è¡Œï¼‰</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -30 sync.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*ç”± [WeRead2Flomo](https://github.com/${{ github.repository }}) è‡ªåŠ¨ç”Ÿæˆ*" >> $GITHUB_STEP_SUMMARY
        
    - name: åˆ›å»ºå¤±è´¥é€šçŸ¥ Issue
      if: failure() && github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let logContent = 'æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨';
          
          if (fs.existsSync('sync.log')) {
            logContent = fs.readFileSync('sync.log', 'utf8');
            // é™åˆ¶æ—¥å¿—é•¿åº¦ï¼Œé¿å… Issue è¿‡å¤§
            if (logContent.length > 10000) {
              logContent = logContent.substring(logContent.length - 10000);
              logContent = '...(æ—¥å¿—å·²æˆªæ–­)\n\n' + logContent;
            }
          }
          
          const title = `ğŸš¨ å®šæ—¶åŒæ­¥å¤±è´¥ - ${new Date().toISOString().split('T')[0]}`;
          const body = `## åŒæ­¥ä»»åŠ¡å¤±è´¥
          
          **æ—¶é—´**: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}
          **Workflow Run**: [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
          
          ### é”™è¯¯æ—¥å¿—
          
          \`\`\`
          ${logContent}
          \`\`\`
          
          ### å¯èƒ½çš„åŸå› 
          
          1. Cookie å·²è¿‡æœŸï¼Œéœ€è¦æ›´æ–°
          2. Flomo API è¾¾åˆ°é™åˆ¶
          3. ç½‘ç»œè¿æ¥é—®é¢˜
          4. é…ç½®é”™è¯¯
          
          ### è§£å†³æ–¹æ¡ˆ
          
          1. æ£€æŸ¥ GitHub Secrets é…ç½®
          2. æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡æµ‹è¯•ï¼šActions â†’ WeRead to Flomo Sync â†’ Run workflow
          3. æŸ¥çœ‹å®Œæ•´æ—¥å¿—ï¼š[ç‚¹å‡»è¿™é‡Œ](${context.payload.repository.html_url}/actions/runs/${context.runId})
          
          ---
          *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`;
          
          // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä»Šå¤©çš„å¤±è´¥ Issue
          const today = new Date().toISOString().split('T')[0];
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'auto-sync-failure',
            per_page: 5
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes(today)
          );
          
          if (existingIssue) {
            // æ›´æ–°ç°æœ‰ Issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `å†æ¬¡å¤±è´¥äº ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}\n\n${body}`
            });
          } else {
            // åˆ›å»ºæ–° Issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['auto-sync-failure', 'bug']
            });
          }
